{
  "name" : "Anthropometry Assessment",
  "uuid" : "d785f701-fbf7-4ee3-b724-09b4b9af2d37",
  "formType" : "ProgramEncounter",
  "formElementGroups" : [ {
    "uuid" : "c5dab868-f04f-4a69-b1fd-5bfeed09262c",
    "name" : "Anthropometry",
    "displayOrder" : 1.0,
    "formElements" : [ {
      "name" : "Skip capturing height",
      "uuid" : "c0166308-e990-437a-8a04-4505b327b5f5",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Skip capturing height",
        "uuid" : "9fa4001d-56cb-45c9-8dd6-69e6f36f4c34",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "Yes",
          "uuid" : "57e20de7-10de-4391-b7ce-87b2f40d19a2",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 1.0,
      "type" : "SingleSelect",
      "mandatory" : false
    }, {
      "name" : "Reason for skipping height capture.",
      "uuid" : "1356302b-4869-47fd-88ff-db323f7060ee",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Reason for skipping height capture.",
        "uuid" : "12684bc5-8064-47a0-9fb7-a1cada81ea03",
        "dataType" : "Text",
        "answers" : [ ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 2.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const formElement = params.formElement;\n  const statusBuilder = new imports.rulesConfig.FormElementStatusBuilder({programEncounter, formElement});\n  statusBuilder.show().when.valueInEncounter(\"Skip capturing height\").is.yes;\n  return statusBuilder.build();\n};",
      "mandatory" : true
    }, {
      "name" : "Height",
      "uuid" : "59c58cc4-3b03-49c4-93b4-2870bd747412",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Height",
        "uuid" : "23bcad9f-ec16-46ec-92f5-e144411e5dec",
        "dataType" : "Numeric",
        "answers" : [ ],
        "lowAbsolute" : 21.0,
        "highAbsolute" : 300.0,
        "lowNormal" : 30.0,
        "highNormal" : 200.0,
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 3.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const formElement = params.formElement;\n  const statusBuilder = new imports.rulesConfig.FormElementStatusBuilder({programEncounter, formElement});\n  statusBuilder.show().when.valueInEncounter(\"Skip capturing height\").is.notDefined;\n  return statusBuilder.build();\n};",
      "mandatory" : true
    }, {
      "name" : "Weight",
      "uuid" : "18ae03de-d8c4-49d2-82c2-ea04e4bb2072",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Weight",
        "uuid" : "8d947379-7a1d-48b2-8760-88fff6add987",
        "dataType" : "Numeric",
        "answers" : [ ],
        "lowAbsolute" : 0.0,
        "highAbsolute" : 300.0,
        "lowNormal" : 1.0,
        "highNormal" : 100.0,
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 4.0,
      "type" : "SingleSelect",
      "mandatory" : true
    } ],
    "display" : "Anthropometry",
    "timed" : false
  } ],
  "decisionRule" : "\"use strict\";\n({params, imports}) => {\n    const programEncounter = params.entity;\n    const decisions = params.decisions;\n    const _ = imports.lodash;\n    const weight = programEncounter.getObservationValue(\"Weight\");\n    const height = programEncounter.getObservationValue(\"Height\");\n    const asOnDate = programEncounter.encounterDateTime;\n    const individual = programEncounter.programEnrolment.individual;\n\n    const zScoreGradeStatusMappingWeightForAge = {\n        '1': 'Normal',\n        '2': 'Moderately Underweight',\n        '3': 'Severely Underweight'\n    };\n\n    const zScoreGradeStatusMappingHeightForAge = {\n        '1': 'Normal',\n        '2': 'Stunted',\n        '3': 'Severely stunted'\n    };\n\n    const zScoreGradeStatusMappingWeightForHeight = [\n        [\"Severely wasted\", -3],\n        [\"Wasted\", -2],\n        [\"Normal\", 1],\n        [\"Possible risk of overweight\", 2],\n        [\"Overweight\", 3],\n        [\"Obese\", Infinity],\n    ];\n\n    const weightForHeightStatus = function (zScore) {\n        let found = _.find(zScoreGradeStatusMappingWeightForHeight, function (currentStatus) {\n            return zScore <= currentStatus[1];\n        });\n        return found && found[0];\n    };\n\n    const getGradeforZscore = (zScore) => {\n        let grade;\n        if (zScore <= -3) {\n            grade = 3;\n        } else if (zScore > -3 && zScore < -2) {\n            grade = 2;\n        } else if (zScore >= -2) {\n            grade = 1;\n        }\n\n        return grade;\n\n    };\n\n    const addIfRequired = (decisions, name, value) => {\n        if (value === -0) value = 0;\n        if (value !== undefined) decisions.push({name: name, value: value});\n    };\n\n    const zScoresForChild = imports.common.getZScore(individual, asOnDate, weight, height);\n\n    const wfaGrade = getGradeforZscore(zScoresForChild.wfa);\n    const wfaStatus = zScoreGradeStatusMappingWeightForAge[wfaGrade];\n    const hfaGrade = getGradeforZscore(zScoresForChild.hfa);\n    const hfaStatus = zScoreGradeStatusMappingHeightForAge[hfaGrade];\n    const wfhStatus = weightForHeightStatus(zScoresForChild.wfh);\n\n    addIfRequired(decisions.encounterDecisions, \"Weight for age z-score\", zScoresForChild.wfa);\n    addIfRequired(decisions.encounterDecisions, \"Weight for age Grade\", wfaGrade);\n    addIfRequired(decisions.encounterDecisions, \"Weight for age Status\", wfaStatus ? [wfaStatus] : []);\n\n    addIfRequired(decisions.encounterDecisions, \"Height for age z-score\", zScoresForChild.hfa);\n    addIfRequired(decisions.encounterDecisions, \"Height for age Grade\", hfaGrade);\n    addIfRequired(decisions.encounterDecisions, \"Height for age Status\", hfaStatus ? [hfaStatus] : []);\n\n    addIfRequired(decisions.encounterDecisions, \"Weight for height z-score\", zScoresForChild.wfh);\n    addIfRequired(decisions.encounterDecisions, \"Weight for Height Status\", wfhStatus ? [wfhStatus] : []);\n    \n    \n    // ------------------------------\n    // Growth Faltering Calculation\n    // ------------------------------\n    // Fetch all past encounters for this enrolment\n    const pastEncounters = imports.common.getEncounters(individual, programEncounter.programEnrolment.program, 'Weight', {before: asOnDate});\n    \n    // Sort encounters by date descending\n    const sortedEncounters = _.orderBy(pastEncounters, ['encounterDateTime'], ['desc']);\n\n    if (sortedEncounters.length >= 1) {\n        // The most recent past encounter is the 1st element\n        const prevEncounter = sortedEncounters[0];\n        const prevWeight = prevEncounter.getObservationValue(\"Weight\");\n\n        if (prevWeight !== undefined && prevWeight !== null) {\n            const weightGain = weight - prevWeight; // kg\n            const growthFaltering = weightGain < 0.3 ? 'Yes' : 'No';\n\n            addIfRequired(decisions.encounterDecisions, \"Previous Encounter Weight\", prevWeight);\n            addIfRequired(decisions.encounterDecisions, \"Weight Gain since last encounter (kg)\", weightGain);\n            addIfRequired(decisions.encounterDecisions, \"Growth Faltering\", growthFaltering);\n        }\n    } else {\n        addIfRequired(decisions.encounterDecisions, \"Growth Faltering\", 'Insufficient data');\n    }\n\n    return decisions;\n};",
  "visitScheduleRule" : "\"use strict\";\n({params, imports}) => {\n    const programEncounter = params.entity;\n    const moment = imports.moment;\n    const _ = imports.lodash;\n    const myGroups = programEncounter.programEnrolment.individual.groups;\n    if (_.isNil(programEncounter.earliestVisitDateTime)) {\n        return [];\n    }\n    const groupSubject = _.get(_.find(myGroups, g => !g.voided && g.groupSubject.subjectType.name === 'Phulwari'), 'groupSubject');\n    const scheduleBuilder = new imports.rulesConfig.VisitScheduleBuilder({\n        programEncounter\n    });\n    const scheduledDateTime = programEncounter.earliestVisitDateTime;\n    \n    if(!_.isNil(groupSubject)){\n    const dayOfMonth = groupSubject.getObservationReadableValue(\"Day of month for growth monitoring visit\");\n    var monthForNextVisit = moment(scheduledDateTime).month() != 11 ? moment(scheduledDateTime).month() + 1 : 0;\n    var earliestDate = moment(scheduledDateTime).month(monthForNextVisit).date(dayOfMonth).toDate();\n    \n    if (moment(earliestDate).month() !== monthForNextVisit) {\n        earliestDate = moment(scheduledDateTime).add(1, 'M').endOf('month').toDate();\n    }else {\n        earliestDate = moment(scheduledDateTime).add(1, 'M').date(dayOfMonth).toDate();\n    }\n    \n    const maxDate = moment(earliestDate).add(3, 'days').toDate();   \n    scheduleBuilder.add({\n            name: \"Growth Monitoring Visit\",\n            encounterType: \"Growth Monitoring\",\n            earliestDate: earliestDate,\n            maxDate: maxDate\n        }\n    );\n    }\n    \n    return scheduleBuilder.getAllUnique(\"encounterType\");\n};",
  "validationRule" : "",
  "checklistsRule" : "",
  "decisionConcepts" : [ {
    "name" : "Height for age Status",
    "uuid" : "60566bc3-018b-409a-82fc-a5d7a2a3e144",
    "dataType" : "Coded",
    "answers" : [ {
      "name" : "Normal",
      "uuid" : "ec89cb1f-491b-46de-95c1-3009effa9041",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 1.0,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Stunted",
      "uuid" : "9274f4b3-976a-4b16-a25b-9837245c1cb9",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 2.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Severely stunted",
      "uuid" : "7d1e2249-5972-42b2-af90-caec71fc5f40",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 3.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    } ],
    "active" : true,
    "media" : [ ]
  }, {
    "name" : "Weight for age z-score",
    "uuid" : "8f369b3d-551d-4311-8e4c-7ee54d9e75ab",
    "dataType" : "Numeric",
    "answers" : [ ],
    "lowNormal" : -2.0,
    "highNormal" : 2.0,
    "active" : true,
    "media" : [ ]
  }, {
    "name" : "Height for age z-score",
    "uuid" : "89defa3b-4924-4a43-85ce-0d3787000ab8",
    "dataType" : "Numeric",
    "answers" : [ ],
    "lowNormal" : -2.0,
    "highNormal" : 2.0,
    "active" : true,
    "media" : [ ]
  }, {
    "name" : "Weight for Height Status",
    "uuid" : "ac397a53-f995-4405-bb98-64aade3f352b",
    "dataType" : "Coded",
    "answers" : [ {
      "name" : "Possible risk of overweight",
      "uuid" : "bb44526f-f56c-4bcb-87d0-e69028e24859",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 2.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Obese",
      "uuid" : "6c2cdb70-6065-4114-93a8-fb15082bc979",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 4.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Overweight",
      "uuid" : "68525b3b-43a2-4044-87b9-01589accd657",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 3.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Normal",
      "uuid" : "ec89cb1f-491b-46de-95c1-3009effa9041",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 1.0,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Wasted",
      "uuid" : "ff73548c-4427-473d-82fe-9e96ffb4b858",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 5.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Severely wasted",
      "uuid" : "f936beac-6e10-4d9f-9ed2-fa59fa7a2834",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 6.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    } ],
    "active" : true,
    "media" : [ ]
  }, {
    "name" : "Weight for age Status",
    "uuid" : "ff26e3db-2499-426d-ba1e-fc3bf7772b90",
    "dataType" : "Coded",
    "answers" : [ {
      "name" : "Normal",
      "uuid" : "ec89cb1f-491b-46de-95c1-3009effa9041",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 1.0,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Severely Underweight",
      "uuid" : "ae2c962e-3ba3-4509-a3fa-764d0031eb3a",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 3.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    }, {
      "name" : "Moderately Underweight",
      "uuid" : "68ed67ed-4401-4e41-a23a-7e1b914f93cd",
      "dataType" : "NA",
      "answers" : [ ],
      "order" : 2.0,
      "abnormal" : true,
      "active" : true,
      "media" : [ ]
    } ],
    "active" : true,
    "media" : [ ]
  }, {
    "name" : "Weight for height z-score",
    "uuid" : "9ee91c02-f965-4045-9248-1b6afaa3a9c9",
    "dataType" : "Numeric",
    "answers" : [ ],
    "lowNormal" : -2.0,
    "highNormal" : 2.0,
    "active" : true,
    "media" : [ ]
  } ]
}