# Docker Compose Override for JSS Bahmni with Local MySQL
# This file:
#   1. Configures local MySQL 5.6 container (x86_64/amd64) - MUST use 5.6 to avoid DST date issues
#   2. Overrides ALL services to use json-file logging (bypasses loki plugin requirement)
#   3. Uses external named volume 'openmrs_db_data' for database persistence
#
# IMPORTANT NOTES:
#   - MySQL 5.6 is required because JSS data contains dates from 1942-1945 (India DST period)
#   - MySQL JDBC 8.x with MySQL 5.7+ causes HOUR_OF_DAY errors on these historical dates
#   - The external volume must be created before starting: docker volume create openmrs_db_data
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.override.yml --profile emr up -d

# Default logging configuration for all services (overrides loki)
x-default-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ============================================================================
  # OpenMRS - Main EMR application
  # ============================================================================
  openmrs:
    depends_on:
      openmrsdb:
        condition: service_healthy
    environment:
      OPENMRS_DB_HOST: openmrsdb
      OPENMRS_SKIP_SEARCH_INDEX: "true"
      OPENMRS_SKIP_LUCENE_INDEX: "true"
      OMRS_DB_EXTRA_ARGS: "&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Calcutta"
    logging: *default-logging

  # ============================================================================
  # MySQL 5.6 - Local database container (x86_64/amd64) - matches JSS prod
  # ============================================================================
  openmrsdb:
    image: mysql:5.6
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-OpenMRS_JSS2024}
      MYSQL_DATABASE: ${OPENMRS_DB_NAME:-openmrs}
      MYSQL_USER: ${OPENMRS_DB_USERNAME:-openmrs_admin}
      MYSQL_PASSWORD: ${OPENMRS_DB_PASSWORD:-OpenMRS_JSS2024}
      TZ: ${TZ:-Asia/Kolkata}
    command: >
      --default-time-zone='+05:30'
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --skip-log-bin
      --max_allowed_packet=256M
      --innodb_buffer_pool_size=512M
    ports:
      - "3306:3306"
    volumes:
      - openmrs_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-OpenMRS_JSS2024}"]
      interval: 10s
      timeout: 20s
      retries: 10
      start_period: 60s
    logging: *default-logging

  # ============================================================================
  # Override logging for all other services to bypass loki plugin
  # ============================================================================
  proxy:
    logging: *default-logging

  bahmni-web:
    logging: *default-logging

  implementer-interface:
    logging: *default-logging

  openelisdb:
    logging: *default-logging

  openelis:
    logging: *default-logging

  reportsdb:
    logging: *default-logging

  reports:
    logging: *default-logging

  pacsdb:
    logging: *default-logging

  dcm4chee:
    logging: *default-logging

  pacs-integration:
    logging: *default-logging

  patient-documents:
    logging: *default-logging

  appointments:
    logging: *default-logging

  rabbitmq:
    logging: *default-logging

  abha-verification:
    logging: *default-logging

  db:
    logging: *default-logging

  hiu:
    logging: *default-logging

  hiu-ui:
    logging: *default-logging

  hiu-db-setup:
    logging: *default-logging

  otp:
    logging: *default-logging

  hip-atomfeed-listener:
    logging: *default-logging

volumes:
  openmrs_db_data:
    external: true
